<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>MetaToRI â€” Emotional Constellation Sky</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  overflow:hidden;
  background:radial-gradient(circle at 50% 50%, #060014 0%, #010010 70%, #000008 100%);
  touch-action:none;
  font-family:-apple-system,BlinkMacSystemFont,"Pretendard","Noto Sans KR",system-ui,sans-serif;
}
canvas{width:100%;height:100%;display:block;}
audio{display:none;}

#controls{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:12px;
  z-index:5;
  opacity:1;
  transition:opacity 1s ease;
}
#controls.hide{opacity:0;pointer-events:none;}
#controls button{
  background:rgba(255,255,255,0.15);
  border:1px solid rgba(255,255,255,0.25);
  color:#fff;
  font-size:22px;
  padding:12px;
  border-radius:50%;
  cursor:pointer;
  backdrop-filter:blur(5px);
  box-shadow:0 0 8px rgba(255,255,255,0.3);
}
#controls button:active{background:rgba(255,255,255,0.4);}

/* â­ NFT ë„˜ë²„ ë¼ë²¨ */
#starLabels{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:4;
}
.star-label{
  position:absolute;
  transform:translate(-50%,-50%);
  font-size:10px;
  color:#ffffff;
  text-shadow:0 0 4px rgba(0,0,0,0.9),0 0 8px rgba(0,0,0,0.9);
  opacity:0;
  transition:opacity 0.25s ease;
  white-space:nowrap;
}

/* ğŸŒ  NFT ìƒì„¸ ëª¨ë‹¬ */
#nftModal{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,15,0.65);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  z-index:10;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.35s ease;
}
#nftModal.show{
  opacity:1;
  pointer-events:auto;
}
#nftModal .modal-card{
  position:relative;
  width:82%;
  max-width:380px;
  border-radius:22px;
  padding:18px 18px 20px;
  color:#fdfdff;
  overflow:hidden;
  transform:scale(0.9);
  opacity:0;
  transition:transform 0.35s ease, opacity 0.35s ease;
}
#nftModal.show .modal-card{
  transform:scale(1);
  opacity:1;
}
#nftModal .modal-card::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 15% 0%, rgba(255,255,255,0.28), transparent 60%),
    radial-gradient(circle at 80% 100%, rgba(255,255,255,0.18), transparent 60%);
  opacity:0.65;
  mix-blend-mode:screen;
  animation:cardStars 9s linear infinite;
  pointer-events:none;
}
@keyframes cardStars{
  0%{transform:translate3d(0,0,0);}
  100%{transform:translate3d(10%, -10%, 0);}
}

#nftModal .modal-inner{
  position:relative;
  z-index:1;
}

#nftModal .modal-close{
  position:absolute;
  top:10px;
  right:10px;
  width:30px;
  height:30px;
  border-radius:999px;
  border:none;
  background:rgba(0,0,0,0.4);
  color:#ffffff;
  font-size:18px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 0 8px rgba(0,0,0,0.7);
}

#nftModal .image-wrap{
  width:100%;
  border-radius:16px;
  overflow:hidden;
  background:rgba(0,0,0,0.5);
  box-shadow:0 0 16px rgba(0,0,0,0.9);
  margin-bottom:14px;
}
#nftModal .image-wrap img{
  width:100%;
  display:block;
}

#nftModal .nft-id{
  font-size:14px;
  letter-spacing:0.14em;
  text-transform:uppercase;
  opacity:0.85;
  margin-bottom:4px;
}
#nftModal .nft-emotion{
  font-size:18px;
  font-weight:700;
  margin-bottom:6px;
}
#nftModal .nft-desc{
  font-size:13px;
  line-height:1.6;
  opacity:0.92;
}

/* ëª¨ë°”ì¼ì—ì„œ ì‚´ì§ ìœ„ë¡œ ë„ìš°ê¸° */
@media (max-height:600px){
  #nftModal .modal-card{
    margin-top:-20px;
  }
}
</style>
</head>
<body>
<audio id="bgm" src="https://github.com/pageno/mtw/raw/main/MetaToriWorld.mp3" autoplay loop></audio>
<canvas id="universe"></canvas>

<div id="controls">
  <button id="zoomIn">ï¼‹</button>
  <button id="zoomOut">ï¼</button>
  <button id="reset">ğŸŒ€</button>
</div>

<!-- â­ NFT ë„˜ë²„ ë¼ë²¨ ì»¨í…Œì´ë„ˆ -->
<div id="starLabels"></div>

<!-- ğŸŒ  NFT ìƒì„¸ ëª¨ë‹¬ -->
<div id="nftModal">
  <div class="modal-card">
    <button id="modalClose" class="modal-close">âœ•</button>
    <div class="modal-inner">
      <div class="image-wrap">
        <img id="nftImage" src="" alt="NFT ì´ë¯¸ì§€" />
      </div>
      <div class="nft-id" id="nftId">#0000</div>
      <div class="nft-emotion" id="nftEmotion">Emotion / ê°ì •</div>
      <div class="nft-desc" id="nftDesc">
        ì´ ë³„ì€ í…ŒìŠ¤íŠ¸ìš© ì„¤ëª…ì…ë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
const canvas = document.getElementById("universe");
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio || 1);
renderer.setClearColor(0x000010, 1);
const scene = new THREE.Scene();

// ğŸ¥ ì¹´ë©”ë¼
const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  10000
);
const startPos = new THREE.Vector3(0, 0, 35);
camera.position.copy(startPos);

const loader = new THREE.TextureLoader();

// ğŸŒ ì§€êµ¬
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(1.4, 64, 64),
  new THREE.MeshPhongMaterial({
    map: loader.load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"),
    emissive: 0x222244,
    emissiveIntensity: 0.7
  })
);
scene.add(earth);

// ğŸ’¡ ì¡°ëª…
const sun = new THREE.PointLight(0xffffff, 2, 0, 2);
sun.position.set(10, 10, 10);
scene.add(sun, new THREE.AmbientLight(0x404060, 0.9));

// ğŸŒˆ ê°ì • 7ìƒ‰ + ë©”íƒ€ ì •ë³´
const emotionColors = [
  0xffd700, // Joy
  0x3c8dff, // Sadness
  0xff4040, // Anger
  0xa5ff9e, // Peace
  0xff8bd8, // Love
  0xb28bff, // Hope
  0x7feaff  // Memory
];

const emotionMeta = [
  { key:"Joy",      label:"JOY Â· ê¸°ì¨",     desc:"ë”°ëœ»í•œ ì›ƒìŒê³¼ ì„¤ë ˜ì´ ë‹´ê¸´ ê¿ˆì˜ ì¡°ê°ì…ë‹ˆë‹¤." },
  { key:"Sadness",  label:"SADNESS Â· ìŠ¬í””", desc:"ì ì‹œ ë©ˆì¶° ì„  ë§ˆìŒ, ê·¸ëŸ¬ë‚˜ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ì´ì•¼ê¸°ì…ë‹ˆë‹¤." },
  { key:"Anger",    label:"ANGER Â· ë¶„ë…¸",   desc:"ìƒì²˜ì™€ ë¶€ë”ªí˜ ì†ì—ì„œë„ ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ë ¤ëŠ” í˜ì…ë‹ˆë‹¤." },
  { key:"Peace",    label:"PEACE Â· í‰ì˜¨",   desc:"ê³ ìš”í•œ ë°¤í•˜ëŠ˜ì²˜ëŸ¼ ë§ˆìŒì´ ê°€ë¼ì•‰ëŠ” ìˆœê°„ì„ ë‹´ì•˜ìŠµë‹ˆë‹¤." },
  { key:"Love",     label:"LOVE Â· ì‚¬ë‘",   desc:"ì†Œì¤‘í•œ ì‚¬ëŒë“¤ì„ ë– ì˜¬ë¦¬ê²Œ í•˜ëŠ” ë‹¤ì •í•œ ë¹›ì…ë‹ˆë‹¤." },
  { key:"Hope",     label:"HOPE Â· í¬ë§",   desc:"ì•„ì§ ì˜¤ì§€ ì•Šì€ ë‚´ì¼ì„ ê¸°ë‹¤ë¦¬ëŠ” ì‘ì€ ë¶ˆì”¨ì…ë‹ˆë‹¤." },
  { key:"Memory",   label:"MEMORY Â· ê¸°ì–µ", desc:"ìŠí˜€ì§€ì§€ ì•Šê¸°ë¥¼ ë°”ë¼ëŠ” ìˆœê°„ë“¤ì„ ë³„ì— ë‹´ì•˜ìŠµë‹ˆë‹¤." }
];

// ëœë¤ NFT ì´ë¯¸ì§€ (í…ŒìŠ¤íŠ¸ìš© ëœë¤ ì´ë¯¸ì§€)
const nftImages = [
  "https://picsum.photos/480/320?random=11",
  "https://picsum.photos/480/320?random=22",
  "https://picsum.photos/480/320?random=33",
  "https://picsum.photos/480/320?random=44",
  "https://picsum.photos/480/320?random=55",
  "https://picsum.photos/480/320?random=66",
  "https://picsum.photos/480/320?random=77"
];

const haloTex = loader.load("https://threejs.org/examples/textures/lensflare/lensflare0.png");

// â­ NFT ë„˜ë²„ ë¼ë²¨ ì»¨í…Œì´ë„ˆ
const labelsContainer = document.getElementById("starLabels");

// í´ë¦­ ê°€ëŠ¥í•œ ë³„ ë¦¬ìŠ¤íŠ¸ & NFT ë„˜ë²„ ì¹´ìš´í„°
const clickableStars = [];
let nftCounter = 1;

// ğŸŒŸ ë³„ ìƒì„± (ì¤‘ì‹¬ ì½”ì–´ + ì˜¤ë¼ + ê°ì •ìƒ‰ + ê¹œë¹¡ì„ + NFT ë©”íƒ€)
function createStar(x, y, z, size = 0.2){
  const emotionIndex = Math.floor(Math.random()*emotionColors.length);
  const colorHex = emotionColors[emotionIndex];
  const color = new THREE.Color(colorHex);

  const mat = new THREE.MeshPhysicalMaterial({
    color,
    emissive: color,
    emissiveIntensity: 2.0,
    roughness: 0.25,
    metalness: 0.3,
    clearcoat: 1,
    transparent: true,
    opacity: 0.98
  });

  const star = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), mat);

  // ì˜¤ë¡œë¼ ëŠë‚Œ halo
  const haloMat = new THREE.SpriteMaterial({
    map: haloTex,
    color,
    transparent: true,
    opacity: 0.9,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });
  const halo = new THREE.Sprite(haloMat);
  halo.scale.set(2.0, 2.0, 1);
  star.add(halo);

  // ì¤‘ì‹¬ ì½”ì–´ ë¹›
  const coreLight = new THREE.PointLight(color, 2.8, 6);
  star.add(coreLight);

  // ê¹œë¹¡ì„ íŒŒë¼ë¯¸í„° (ë³„ë§ˆë‹¤ ë‹¤ë¥´ê²Œ)
  const twinkleSpeeds = [0.5, 0.8, 1.3, 1.9];
  const twinkleSpeed = twinkleSpeeds[Math.floor(Math.random()*twinkleSpeeds.length)];
  const twinkleIntensity = 0.8 + Math.random()*0.6; // 0.8~1.4
  const phase = Math.random()*Math.PI*2;

  // NFT ë„˜ë²„ & ëœë¤ ì´ë¯¸ì§€
  const nftId = String(nftCounter++).padStart(4,"0");
  const imageUrl = nftImages[Math.floor(Math.random()*nftImages.length)];

  // HTML ë¼ë²¨ ìƒì„± (NFT ë„˜ë²„)
  const label = document.createElement("div");
  label.className = "star-label";
  label.textContent = "#" + nftId;
  labelsContainer.appendChild(label);

  star.position.set(x, y, z);
  star.userData = {
    isStar: true,
    halo,
    coreLight,
    twinkleSpeed,
    twinkleIntensity,
    phase,
    emotionIndex,
    colorHex,
    nftId,
    imageUrl,
    label
  };

  clickableStars.push(star);
  return star;
}

// ğŸŒŒ ë³„ìë¦¬ ë°ì´í„° (ì—¬ëŸ¬ ëŒ€í‘œ ë³„ìë¦¬, ëŒ€ëµì  í˜•íƒœ)
const constellationsData = {
  "Orion":[[-5,6,-3],[-3,3,-3],[-1,0,-2],[1,0,-2],[3,0,-2],[5,2,-3],[6,-2,-3]],
  "UrsaMajor":[[-8,8,-4],[-6,6,-3],[-4,4,-3],[-2,3,-2],[0,2,-2],[2,0,-2],[4,-2,-3]],
  "Cassiopeia":[[-5,-6,2],[-3,-4,3],[-1,-2,4],[1,-3,4],[3,-5,3]],
  "Scorpius":[[2,-8,4],[3,-9,5],[4,-10,4],[5,-11,3],[6,-12,2]],
  "Pleiades":[[5,7,-2],[6,8,-2],[7,9,-3],[8,8,-3],[9,7,-2],[10,8,-3],[11,9,-3]],
  "Andromeda":[[0,-6,-5],[1,-7,-6],[2,-8,-7],[3,-9,-6],[4,-8,-5]],
  "Pegasus":[[-10,-8,-5],[-9,-9,-6],[-8,-10,-7],[-7,-9,-6],[-6,-8,-5]],
  "Leo":[[-8,3,-2],[-7,2,-1],[-6,1,0],[-5,0,1],[-4,-1,2]],
  "Virgo":[[-2,7,5],[-1,8,4],[0,9,3],[1,8,2]],
  "Aquarius":[[7,-4,6],[8,-5,6],[9,-6,5],[10,-7,4]],
  "Pisces":[[4,-2,4],[5,-3,5],[6,-4,5],[7,-5,4]],
  "Aquila":[[3,6,5],[4,7,5],[5,8,4],[6,9,3]],
  "Cygnus":[[-3,5,6],[-2,6,6],[-1,7,5],[0,8,4],[1,9,3]],
  "Draco":[[-9,4,5],[-8,5,5],[-7,6,4],[-6,7,3]],
  "Sagittarius":[[5,-7,7],[6,-8,6],[7,-9,5],[8,-10,4]],
  "Aries":[[-3,-5,6],[-2,-4,6],[-1,-3,5],[0,-2,4]],
  "Cancer":[[-4,2,5],[-3,3,5],[-2,4,4],[-1,5,3]],
  "Capricornus":[[2,-6,7],[3,-7,6],[4,-8,5],[5,-9,4]],
  "Ophiuchus":[[0,-10,6],[1,-11,5],[2,-12,4],[3,-13,3]],
  "UrsaMinor":[[8,6,-4],[7,5,-3],[6,4,-2],[5,3,-1],[4,2,0]]
};

// ğŸŒ  ë³„ìë¦¬ ìƒì„± (ëª¨ë‘ ê°™ì€ ë°˜ì§€ë¦„ ì‰˜ ìœ„ì— íˆ¬ì˜)
const constellations = [];
const CONST_RADIUS = 14; // ì§€êµ¬ì—ì„œ ë³„ìë¦¬ê¹Œì§€ ê±°ë¦¬ í†µì¼

function createConstellation(name, coords, lineColor){
  const group = new THREE.Group();
  group.userData.name = name;

  const points = [];
  const projectedCoords = [];

  let maxLen = 0;
  coords.forEach(([x,y,z])=>{
    const len = Math.sqrt(x*x + y*y + z*z);
    if(len > maxLen) maxLen = len;
  });
  if (maxLen < 0.0001) maxLen = 1;

  const scale = CONST_RADIUS / maxLen;

  coords.forEach(([x,y,z])=>{
    const vx = x * scale;
    const vy = y * scale;
    const vz = z * scale;
    projectedCoords.push([vx,vy,vz]);
    points.push(new THREE.Vector3(vx,vy,vz));
  });

  // ì—°ê²° ì„ 
  const mat = new THREE.LineBasicMaterial({
    color: lineColor,
    transparent: true,
    opacity: 0.35
  });
  const geo = new THREE.BufferGeometry().setFromPoints(points);
  const line = new THREE.Line(geo, mat);
  group.add(line);

  // ê° ì ì— ë³„ ìƒì„±
  projectedCoords.forEach(([x,y,z])=>{
    const s = createStar(x,y,z);
    group.add(s);
  });

  scene.add(group);
  return group;
}

// â­ ëª¨ë“  ë³„ìë¦¬ ìƒì„±
Object.entries(constellationsData).forEach(([name,coords])=>{
  constellations.push(createConstellation(name, coords, 0x88aaff));
});

// ğŸŒŒ ë°°ê²½ ë³„
const starGeo = new THREE.BufferGeometry();
const pos = new Float32Array(5000*3);
for(let i=0;i<5000;i++){
  const r = 400 + Math.random()*1000;
  const t = Math.random()*Math.PI*2;
  const p = Math.acos((Math.random()*2)-1);
  pos[i*3]   = r*Math.sin(p)*Math.cos(t);
  pos[i*3+1] = r*Math.sin(p)*Math.sin(t);
  pos[i*3+2] = r*Math.cos(p);
}
starGeo.setAttribute("position", new THREE.BufferAttribute(pos,3));
const pts = new THREE.Points(
  starGeo,
  new THREE.PointsMaterial({
    color:0xffffff,
    size:1.1,
    transparent:true,
    opacity:0.8,
    blending:THREE.AdditiveBlending
  })
);
scene.add(pts);

// ğŸ ì• ë‹ˆë©”ì´ì…˜ (íšŒì „ + ì¤‘ì‹¬ ë°œê´‘ + ì˜¤ë¡œë¼ íŒŒë„)
const tmpVec = new THREE.Vector3();
let isPaused = false;
let isModalOpen = false;

function updateStarLabels(){
  const show = camera.position.z < 15 && !isModalOpen;
  const width = window.innerWidth;
  const height = window.innerHeight;
  const proj = new THREE.Vector3();

  clickableStars.forEach(star=>{
    const data = star.userData;
    const label = data.label;
    if(!label) return;

    if(!show){
      label.style.opacity = 0;
      return;
    }

    star.getWorldPosition(tmpVec);
    proj.copy(tmpVec).project(camera);

    const x = (proj.x * 0.5 + 0.5) * width;
    const y = (-proj.y * 0.5 + 0.5) * height + 14; // ë³„ ì•„ë˜ìª½

    label.style.left = x + "px";
    label.style.top  = y + "px";
    label.style.opacity = 1;
  });
}

function animate(){
  requestAnimationFrame(animate);

  const time = Date.now()*0.002;

  if(!isPaused){
    earth.rotation.y += 0.0004;
    pts.rotation.y   += 0.00008;
    constellations.forEach(g => { g.rotation.y += 0.00025; });
  }

  // ë³„ ê¹œë¹¡ì„ / ì˜¤ë¡œë¼ íŒŒë™
  scene.traverse(obj=>{
    if(obj.userData && obj.userData.isStar){
      const d = obj.userData;

      obj.getWorldPosition(tmpVec);
      const dist = tmpVec.length();
      const wavePhase = dist * 0.25;
      const globalWave = Math.sin(time*0.7 + wavePhase)*0.5 + 0.5;

      const localWave = Math.sin(time*d.twinkleSpeed + d.phase)*0.5 + 0.5;

      const tw = (localWave*0.6 + globalWave*0.4);

      obj.material.emissiveIntensity = 2.6 * d.twinkleIntensity * (0.6 + 0.4*tw);

      if(d.coreLight){
        d.coreLight.intensity = 3.2 * d.twinkleIntensity * (0.6 + 0.4*tw);
      }

      if(d.halo){
        d.halo.material.opacity = 0.45 + 0.5 * tw;
        const scale = 1.7 + 0.6 * tw;
        d.halo.scale.set(scale, scale, 1);
      }
    }
  });

  renderer.render(scene, camera);
  updateStarLabels();
}
animate();

// âœ‹ ë“œë˜ê·¸ íšŒì „ + í´ë¦­ êµ¬ë¶„
let dragging=false,lastX=0,lastY=0,downX=0,downY=0,moved=false;

canvas.addEventListener("pointerdown",e=>{
  dragging=true;
  lastX = downX = e.clientX;
  lastY = downY = e.clientY;
  moved=false;
  showControls();
});

window.addEventListener("pointermove",e=>{
  if(!dragging)return;
  const dx=e.clientX-lastX,dy=e.clientY-lastY;
  if(Math.abs(e.clientX-downX)>3 || Math.abs(e.clientY-downY)>3) moved=true;
  lastX=e.clientX;lastY=e.clientY;
  scene.rotation.y+=dx*0.002;
  scene.rotation.x+=dy*0.002;
  showControls();
});

window.addEventListener("pointerup",e=>{
  if(dragging && !moved && !isModalOpen && camera.position.z < 15){
    handleStarClick(e);
  }
  dragging=false;
});

// ğŸ” Raycaster ë¥¼ ì´ìš©í•œ ë³„ í´ë¦­
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function handleStarClick(e){
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(clickableStars);
  if(intersects.length>0){
    const star = intersects[0].object;
    openNftModal(star);
  }
}

// ğŸŒ  NFT ëª¨ë‹¬ ì œì–´
const nftModal   = document.getElementById("nftModal");
const modalClose = document.getElementById("modalClose");
const nftImageEl   = document.getElementById("nftImage");
const nftIdEl      = document.getElementById("nftId");
const nftEmotionEl = document.getElementById("nftEmotion");
const nftDescEl    = document.getElementById("nftDesc");

function hexToRgbComponents(hex){
  const c = new THREE.Color(hex);
  return {
    r:Math.round(c.r*255),
    g:Math.round(c.g*255),
    b:Math.round(c.b*255)
  };
}

function openNftModal(star){
  const d = star.userData;
  const meta = emotionMeta[d.emotionIndex] || emotionMeta[0];

  nftImageEl.src = d.imageUrl;
  nftIdEl.textContent = "#" + d.nftId;
  nftEmotionEl.textContent = meta.label;
  nftDescEl.textContent = meta.desc;

  const {r,g,b} = hexToRgbComponents(d.colorHex);

  const card = nftModal.querySelector(".modal-card");
  card.style.background =
    `radial-gradient(circle at 0% 0%, rgba(${r},${g},${b},0.95), rgba(4,0,20,0.98) 55%, rgba(0,0,0,0.98) 100%)`;
  card.style.boxShadow =
    `0 0 25px rgba(${r},${g},${b},0.95), 0 0 80px rgba(${r},${g},${b},0.7)`;

  nftModal.classList.add("show");
  isModalOpen = true;
  isPaused = true;
}

function closeNftModal(){
  nftModal.classList.remove("show");
  isModalOpen = false;
  isPaused = false;
}

modalClose.addEventListener("click", closeNftModal);
nftModal.addEventListener("click", e=>{
  if(e.target === nftModal){ // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    closeNftModal();
  }
});

// ğŸ”˜ ë²„íŠ¼ (ì¤Œ ì¸/ì•„ì›ƒ/ì›ì )
document.getElementById("zoomIn").onclick=()=>{
  camera.position.z = Math.max(4, camera.position.z - 1.5);
  showControls();
};
document.getElementById("zoomOut").onclick=()=>{
  camera.position.z = Math.min(90, camera.position.z + 1.5);
  showControls();
};
document.getElementById("reset").onclick=()=>{
  camera.position.copy(startPos);
  showControls();
};

// ğŸ› ë²„íŠ¼ ìë™ ìˆ¨ê¹€
const controls = document.getElementById("controls");
let hideTimer=null;
function showControls(){
  controls.classList.remove("hide");
  clearTimeout(hideTimer);
  hideTimer = setTimeout(()=>controls.classList.add("hide"), 3000);
}
showControls();

// ğŸ”‰ ë°°ê²½ìŒ (ëª¨ë°”ì¼: ì²« í„°ì¹˜ì—ì„œ ì¬ìƒ ë³´ì¥)
const bgm = document.getElementById("bgm");
bgm.volume = 0.35;
document.body.addEventListener("pointerdown", ()=>{ if(bgm.paused) bgm.play(); });

// ğŸŒ  ê°ì •ë³„ ë³„ íƒ„ìƒ ì• ë‹ˆë©”ì´ì…˜ (ì§€êµ¬ì—ì„œ ë– ì˜¬ë¼ ë¹›ë‚˜ëŠ” ë³„ 50ê°œ, 15ì´ˆ ê°„ê²©)
let bornCount = 0;
const MAX_STARS = 50;

function birthStar() {
  if (bornCount >= MAX_STARS) return;
  bornCount++;

  // ğŸŒˆ ìƒ‰ìƒê³¼ í¬ê¸° ëœë¤
  const colorHex = emotionColors[Math.floor(Math.random() * emotionColors.length)];
  const color = new THREE.Color(colorHex);
  const size = 0.25 + Math.random() * 0.4; // 0.25~0.65

  const mat = new THREE.MeshPhysicalMaterial({
    color: 0xffffff,
    emissive: 0xffffff,
    emissiveIntensity: 0.2,
    transparent: true,
    opacity: 0.25,
    roughness: 0.3,
    metalness: 0.3
  });

  const star = new THREE.Mesh(new THREE.SphereGeometry(size, 32, 32), mat);
  const haloMat = new THREE.SpriteMaterial({
    map: haloTex,
    color: 0xffffff,
    transparent: true,
    opacity: 0.25,
    blending: THREE.AdditiveBlending
  });
  const halo = new THREE.Sprite(haloMat);
  halo.scale.set(2.0, 2.0, 1);
  star.add(halo);

  // ì‹œì‘ ìœ„ì¹˜ (ì§€êµ¬ ê·¼ì²˜ ëœë¤)
  const startPos = new THREE.Vector3(
    (Math.random() - 0.5) * 1.5,
    (Math.random() - 0.5) * 1.5,
    (Math.random() - 0.5) * 1.5
  );
  // ëª©í‘œ ìœ„ì¹˜ (ì§€êµ¬ ìœ„ìª½ ëœë¤í•œ ë°©í–¥)
  const targetPos = new THREE.Vector3(
    (Math.random() - 0.5) * 20,
    8 + Math.random() * 6,
    (Math.random() - 0.5) * 10
  );

  star.position.copy(startPos);
  scene.add(star);

  const start = performance.now();
  const duration1 = 5000; // 5ì´ˆ ì´ë™
  const duration2 = 5000; // 5ì´ˆ ë¹› ë³€í™”

  function animateBirth() {
    const now = performance.now();
    const elapsed = now - start;

    if (elapsed < duration1) {
      const t = elapsed / duration1;
      const ease = t * t * (3 - 2 * t);
      star.position.lerpVectors(startPos, targetPos, ease);
      mat.opacity = 0.25 + ease * 0.3;
      haloMat.opacity = 0.25 + ease * 0.3;
      requestAnimationFrame(animateBirth);
    } else if (elapsed < duration1 + duration2) {
      const t = (elapsed - duration1) / duration2;
      const ease = t * t * (3 - 2 * t);
      mat.color.lerp(color, ease);
      mat.emissive.lerp(color, ease);
      mat.emissiveIntensity = 0.2 + ease * 3;
      haloMat.color.lerp(color, ease);
      haloMat.opacity = 0.4 + ease * 0.6;
      requestAnimationFrame(animateBirth);
    } else {
      mat.color.set(color);
      mat.emissive.set(color);
      mat.emissiveIntensity = 2.8;
      haloMat.color.set(color);
      haloMat.opacity = 1.0;
    }
  }
  animateBirth();
}

// 15ì´ˆë§ˆë‹¤ í•˜ë‚˜ì”© ìƒì„± (ìµœëŒ€ 50ê°œ)
birthStar();
const birthInterval = setInterval(() => {
  if (bornCount >= MAX_STARS) {
    clearInterval(birthInterval);
  } else {
    birthStar();
  }
}, 15000);

// ì‹¤í–‰
birthStar();

// ğŸ” ë¦¬ì‚¬ì´ì¦ˆ
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
