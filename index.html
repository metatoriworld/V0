<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>MetaToRI ‚Äî Gem Constellation Edition</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  overflow:hidden;
  background:radial-gradient(circle at 50% 50%, #050011 0%, #01000a 70%, #000006 100%);
  font-family:"Pretendard",system-ui,sans-serif;
}
canvas{
  width:100%;
  height:100%;
  display:block;
  touch-action:none;
  transition:filter 0.4s ease;
}
canvas.blur{filter:blur(6px);}

/* üåë Îí∑Î∞∞Í≤Ω Ïª§Î≤Ñ */
#backCover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  opacity:0;
  pointer-events:none;
  transition:opacity 0.4s ease;
  z-index:5;
}
#backCover.active{
  opacity:1;
  pointer-events:auto;
}

/* üå† Ï§ëÏïô NFT Ïπ¥Îìú */
#nftCard{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(0.8);
  background:rgba(10,10,20,0.9);
  border-radius:20px;
  padding:24px;
  width:85%;
  max-width:400px;
  text-align:center;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.5s ease, transform 0.45s ease;
  z-index:10;
}
#nftCard.active{
  opacity:1;
  pointer-events:auto;
  transform:translate(-50%,-50%) scale(1);
}
#nftImage{
  width:120px;
  height:120px;
  border-radius:50%;
  object-fit:cover;
  margin-bottom:14px;
  box-shadow:0 0 25px rgba(255,255,255,0.7);
}
#nftTitle{margin:4px 0;font-size:1.15rem;color:#fff;}
#nftDesc{margin:6px 0 8px;font-size:0.9rem;line-height:1.4;color:#ddd;}
#nftWallet{font-size:0.8rem;opacity:0.75;color:#aaa;}

/* üåà Ï¢åÏ∏° ÏÉÅÎã® Î°úÍ≥† */
#logo{
  position:fixed;
  top:10px;
  left:10px;
  width:60px;
  height:auto;
  z-index:15;
  opacity:0.9;
}
</style>
</head>
<body>
<canvas id="universe"></canvas>

<!-- üåà Î°úÍ≥† -->
<img id="logo" src="https://raw.githubusercontent.com/metatoriworld/Image/main/mtllg.png" alt="MetaToRI Logo">

<div id="backCover"></div>

<div id="nftCard">
  <img id="nftImage" src="" alt="NFT Image" />
  <h2 id="nftTitle"></h2>
  <p id="nftDesc"></p>
  <div id="nftWallet"></div>
</div>

<!-- üéµ Î∞∞Í≤ΩÏùåÏïÖ -->
<audio id="bgm" src="https://raw.githubusercontent.com/metatoriworld/Image/main/mtlm1.mp3" loop></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three-spritetext@1.6.5/dist/three-spritetext.min.js"></script>
<script>
/* üéµ Ïò§ÎîîÏò§ ÏûêÎèô Ïû¨ÏÉù (Î™®Î∞îÏùº ÎåÄÏùë) */
const bgm=document.getElementById("bgm");
bgm.volume=0.3;
function tryPlay(){
  bgm.play().catch(()=>{});
  window.removeEventListener("touchstart",tryPlay);
}
window.addEventListener("touchstart",tryPlay);

const canvas=document.getElementById("universe");
const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setClearColor(0x000010,1);

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,3000);
camera.position.set(0,0,150);
const cameraTarget=new THREE.Vector3(0,0,0);

const MIN_DISTANCE=3,MAX_DISTANCE=400,ORBIT_SPEED=0.005,SCENE_ORBIT_SPEED=0.0002;
const FOV_MAX=60,FOV_MIN=5;
let isTouching=false,touches=[],prevDistance=0,prevClientX=0,prevClientY=0;
let rotationPaused=false;
let touchMoved=false;
let moveThreshold=5;
let startX=0,startY=0;

// üåç Earth
const loader=new THREE.TextureLoader();
const earth=new THREE.Mesh(
  new THREE.SphereGeometry(2,64,64),
  new THREE.MeshPhongMaterial({
    map:loader.load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg"),
    emissive:0x222244,emissiveIntensity:0.9
  })
);
scene.add(earth);

// üí° Light
const sun=new THREE.PointLight(0xffffff,2,0,2);
sun.position.set(15,10,10);
scene.add(sun);
scene.add(new THREE.AmbientLight(0x303040,1));

// üíé Gem Colors
const gemColors=[
  0xe0115f,0x0f52ba,0x50c878,0xffd700,0x9966cc,0x8b0000,
  0xa8c3bc,0xb4d200,0x40e0d0,0xffffff,0xff69b4,0x353839
];
const haloTex=loader.load("https://threejs.org/examples/textures/lensflare/lensflare0.png");
const plasmaTex=loader.load("https://threejs.org/examples/textures/lava/cloud.png");
const roundStarTex=loader.load("https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/sprites/circle.png");
plasmaTex.wrapS=plasmaTex.wrapT=THREE.RepeatWrapping;

// üåü Create Star
let nftCounter=1;
function createStar(x,y,z,size=0.25,starColor){
  const color=new THREE.Color(starColor||gemColors[Math.floor(Math.random()*gemColors.length)]);
  const group=new THREE.Group();
  group.position.set(x,y,z);
  group.userData.nftId=nftCounter++;
  group.userData.baseColor=color;
  group.userData.phase=Math.random()*Math.PI*2;
  group.userData.colorKey=color.getHex();

  const core=new THREE.Mesh(
    new THREE.SphereGeometry(size*0.6,32,32),
    new THREE.MeshBasicMaterial({color:color,transparent:true,opacity:0.9,blending:THREE.AdditiveBlending})
  );
  const atmosphere=new THREE.Mesh(
    new THREE.SphereGeometry(size*2,16,16),
    new THREE.MeshBasicMaterial({
      map:plasmaTex,color:color,transparent:true,opacity:0.5,
      blending:THREE.AdditiveBlending,depthWrite:false
    })
  );
  const halo=new THREE.Sprite(new THREE.SpriteMaterial({
    map:haloTex,color:color,transparent:true,opacity:0.8,blending:THREE.AdditiveBlending
  }));
  halo.scale.set(size*12,size*12,1);

  const label=new SpriteText(`#${group.userData.nftId}`,0.2,"#ffffff");
  label.position.set(0.5,0.5,0);

  group.add(core,atmosphere,halo,label);
  scene.add(group);
  return group;
}

// üåå Stars
const stars=[];
const totalStars=1200;
for(let i=0;i<totalStars;i++){
  const r=20+Math.random()*100;
  const theta=Math.random()*Math.PI*2;
  const phi=Math.acos((Math.random()*2)-1);
  const x=r*Math.sin(phi)*Math.cos(theta);
  const y=r*Math.sin(phi)*Math.sin(theta);
  const z=r*Math.cos(phi);
  stars.push(createStar(x,y,z,0.18+Math.random()*0.15));
}

// üå† Background Stars
const farGeo=new THREE.BufferGeometry();
const farCount=6000;
const farPos=new Float32Array(farCount*3);
for(let i=0;i<farCount;i++){
  const r=150+Math.random()*400;
  const t=Math.random()*Math.PI*2;
  const p=Math.acos((Math.random()*2)-1);
  farPos[i*3]=r*Math.sin(p)*Math.cos(t);
  farPos[i*3+1]=r*Math.sin(p)*Math.sin(t);
  farPos[i*3+2]=r*Math.cos(p);
}
farGeo.setAttribute("position",new THREE.BufferAttribute(farPos,3));
const farStars=new THREE.Points(farGeo,new THREE.PointsMaterial({
  map:roundStarTex,color:0xffffff,size:1.3,transparent:true,opacity:0.85,
  blending:THREE.AdditiveBlending,sizeAttenuation:true
}));
scene.add(farStars);

// üåå Ïó∞Í≤∞ÏÑ†
const colorGroups={};
for(const s of stars){
  const hex=s.userData.colorKey;
  if(!colorGroups[hex]) colorGroups[hex]=[];
  colorGroups[hex].push(s.position);
}
for(const hex in colorGroups){
  const group=colorGroups[hex];
  const points=[];
  for(let i=0;i<group.length;i++){
    const a=group[i];
    for(let j=i+1;j<group.length;j++){
      const b=group[j];
      const dist=a.distanceTo(b);
      if(dist<15){points.push(a.x,a.y,a.z,b.x,b.y,b.z);}
    }
  }
  const geo=new THREE.BufferGeometry();
  geo.setAttribute("position",new THREE.Float32BufferAttribute(points,3));
  const mat=new THREE.LineBasicMaterial({color:parseInt(hex),transparent:true,opacity:0.4,blending:THREE.AdditiveBlending});
  scene.add(new THREE.LineSegments(geo,mat));
}

// üñêÔ∏è Controls
function getDistance(t1,t2){const dx=t1.clientX-t2.clientX,dy=t1.clientY-t2.clientY;return Math.sqrt(dx*dx+dy*dy);}
function orbitCamera(dx,dy){
  const s=ORBIT_SPEED*1.5;
  const dist=camera.position.distanceTo(cameraTarget);
  const offset=new THREE.Vector3().subVectors(camera.position,cameraTarget);
  const ry=new THREE.Matrix4().makeRotationY(-dx*s);
  offset.applyMatrix4(ry);
  let newY=offset.y-dy*s*dist;
  newY=THREE.MathUtils.clamp(newY,-dist*1.2,dist*1.2);
  offset.y=newY;
  camera.position.copy(cameraTarget).add(offset.normalize().multiplyScalar(dist));
}

function onTouchStart(e){
  e.preventDefault();
  isTouching=true;
  touchMoved=false;
  touches=Array.from(e.touches);
  if(touches.length===1){
    startX=touches[0].clientX;
    startY=touches[0].clientY;
    prevClientX=startX;
    prevClientY=startY;
  }else if(touches.length===2){
    prevDistance=getDistance(touches[0],touches[1]);
  }
}

function onTouchMove(e){
  if(!isTouching)return;
  e.preventDefault();
  const current=Array.from(e.touches);

  if(current.length===1){
    const dx=current[0].clientX-startX;
    const dy=current[0].clientY-startY;
    if(Math.sqrt(dx*dx+dy*dy)>moveThreshold) touchMoved=true;
  }else{
    touchMoved=true;
  }

  if(current.length===2){
    const d=getDistance(current[0],current[1]);
    const dd=d-prevDistance;
    const dist=camera.position.distanceTo(cameraTarget);
    const zf=dd*0.005*(dist/50);
    const dir=new THREE.Vector3().subVectors(camera.position,cameraTarget).normalize();
    const mv=dir.multiplyScalar(dist*zf);camera.position.add(mv);
    const newDist=camera.position.distanceTo(cameraTarget);
    if(newDist<MIN_DISTANCE||newDist>MAX_DISTANCE){camera.position.sub(mv);}
    prevDistance=d;
  }else if(current.length===1){
    const cx=current[0].clientX,cy=current[0].clientY;
    orbitCamera(cx-prevClientX,cy-prevClientY);
    prevClientX=cx;prevClientY=cy;
  }
  touches=current;
}

function onTouchEnd(e){
  if(!isTouching)return;
  isTouching=false;
  if(!touchMoved){
    const t=e.changedTouches[0];
    detectStar(t.clientX,t.clientY);
  }
  touches=[];
}

window.addEventListener("touchstart",onTouchStart,{passive:false});
window.addEventListener("touchmove",onTouchMove,{passive:false});
window.addEventListener("touchend",onTouchEnd,{passive:false});

// üéØ Raycaster + Ïπ¥Îìú
const raycaster=new THREE.Raycaster();
raycaster.params.Points={threshold:2.5};
const pointer=new THREE.Vector2();
const backCover=document.getElementById("backCover");
const nftCard=document.getElementById("nftCard");
const nftImage=document.getElementById("nftImage");
const nftTitle=document.getElementById("nftTitle");
const nftDesc=document.getElementById("nftDesc");
const nftWallet=document.getElementById("nftWallet");

function openCard(star){
  rotationPaused=true;
  canvas.classList.add("blur");
  backCover.classList.add("active");
  canvas.style.pointerEvents="none";
  const color=star.userData.baseColor.getStyle();
  nftCard.style.border=`2px solid ${color}`;
  nftCard.style.boxShadow=`0 0 25px ${color}`;
  const c=document.createElement("canvas");c.width=200;c.height=200;
  const ctx=c.getContext("2d");
  const grad=ctx.createRadialGradient(100,100,20,100,100,100);
  grad.addColorStop(0,color);grad.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=grad;ctx.beginPath();ctx.arc(100,100,100,0,Math.PI*2);ctx.fill();
  nftImage.src=c.toDataURL("image/png");
  nftTitle.textContent=`NFT #${star.userData.nftId}`;
  nftDesc.textContent="Ïù¥ Î≥ÑÏùÄ MetaToRI Emotional SkyÏùò Í∞êÏ†ï Î≥¥ÏÑù Ï§ë ÌïòÎÇòÏûÖÎãàÎã§.";
  nftWallet.textContent="ÏßÄÍ∞ë Ï£ºÏÜå : 0x1234...ABCD";
  nftCard.classList.add("active");
}

// üîí Î™®Îã¨ Ï§ë Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ï∞®Îã® Î∞è Îã´Í∏∞
["touchstart","touchmove","touchend"].forEach(evt=>{
  backCover.addEventListener(evt,e=>e.stopPropagation(),{passive:false});
});
backCover.addEventListener("click",closeCard);
backCover.addEventListener("touchstart",closeCard);

function closeCard(){
  nftCard.classList.remove("active");
  backCover.classList.remove("active");
  canvas.classList.remove("blur");
  setTimeout(()=>{
    canvas.style.pointerEvents="auto";
    rotationPaused=false;
  },450);
}

// ‚≠ê ÌÅ¥Î¶≠ Í∞êÏßÄ
function detectStar(x,y){
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width;
  const scaleY=canvas.height/rect.height;
  const canvasX=(x-rect.left)*scaleX;
  const canvasY=(y-rect.top)*scaleY;
  pointer.x=(canvasX/canvas.width)*2-1;
  pointer.y=-(canvasY/canvas.height)*2+1;
  raycaster.setFromCamera(pointer,camera);
  const clickable=stars.flatMap(s=>[s.children[0],s.children[2]]);
  const intersects=raycaster.intersectObjects(clickable,true);
  if(intersects.length===0)return;
  const obj=intersects[0].object;
  const star=stars.find(s=>s.children.includes(obj));
  if(!star)return;
  const dist=camera.position.distanceTo(star.position);
  if(dist>180)return;
  openCard(star);
}

function animate(){
  requestAnimationFrame(animate);
  const t=performance.now()*0.001;
  const dist=camera.position.distanceTo(cameraTarget);
  camera.fov=THREE.MathUtils.mapLinear(dist,MAX_DISTANCE,MIN_DISTANCE,FOV_MAX,FOV_MIN);
  camera.updateProjectionMatrix();
  camera.lookAt(cameraTarget);
  if(!isTouching && !rotationPaused){
    earth.rotation.y+=0.0004;
    farStars.rotation.y+=0.00003;
    scene.rotation.y+=SCENE_ORBIT_SPEED;
  }
  stars.forEach(s=>{
    const core=s.children[0],atmosphere=s.children[1],halo=s.children[2],label=s.children[3];
    const phase=s.userData.phase;
    const flicker=(Math.sin(t*2.5+phase)*0.5+0.5);
    core.material.opacity=0.6+0.4*flicker;
    atmosphere.material.opacity=0.4+0.4*flicker;
    halo.material.opacity=0.3+0.7*flicker;
    if(label)label.visible=(camera.position.distanceTo(s.position)<110);
  });
  renderer.render(scene,camera);
}
animate();

// üîÅ Resize
window.addEventListener("resize",()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
